name: Portfolio Site CI/CD

'on':
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node.js dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Validate YAML files with yamllint
        run: |
          echo "Installing yamllint..."
          pip install yamllint

          echo "Validating YAML files for syntax and style..."

          # Run yamllint on data directory
          if [ -d "data" ]; then
            yamllint data/
            echo "✅ All YAML files in data/ directory are valid!"
          else
            echo "⚠️  data/ directory not found, skipping YAML validation"
          fi

          # Also validate workflow files
          if [ -d ".github/workflows" ]; then
            yamllint .github/workflows/
            echo "✅ GitHub workflow YAML files are valid!"
          fi

      - name: Check Python code formatting with Black
        run: |
          echo "Checking Python code formatting..."
          black --check --diff .

      - name: Lint Python code with flake8
        run: |
          pip install flake8
          echo "Linting Python code..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=node_modules,dist

      - name: Test site generation
        run: |
          echo "Testing site generation..."
          python generate_site.py

      - name: Install LaTeX
        run: |
          echo "Installing LaTeX..."
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-fonts-recommended texlive-latex-extra texlive-fonts-extra

      - name: Generate resume PDF
        run: |
          echo "Generating resume PDF..."
          python generate_resume.py
          echo "✅ Resume PDF generated successfully"

      - name: Build CSS with Tailwind
        run: |
          echo "Building CSS..."
          npm run build-css || npm run build || echo "No build script found, skipping CSS build"

      - name: Validate generated HTML
        run: |
          echo "Validating generated HTML..."
          if [ -f "index.html" ]; then
            echo "✅ index.html generated successfully"
            # Basic HTML validation - check if file contains expected structure
            if grep -q "<html" index.html && grep -q "</html>" index.html; then
              echo "✅ HTML structure looks valid"
            else
              echo "❌ HTML structure appears invalid"
              exit 1
            fi
          else
            echo "❌ index.html was not generated"
            exit 1
          fi

      - name: Upload resume PDF as artifact
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdf
          path: resume.pdf
          retention-days: 90

      - name: Create/Update Release with Resume PDF
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-resume
          name: Latest Resume
          body: Auto-generated resume PDF from latest commit
          files: resume.pdf
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

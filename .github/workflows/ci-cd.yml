name: Portfolio Site CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Node.js dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        else
          echo "No package.json found, skipping npm install"
        fi
      
    - name: Validate YAML files with yamllint
      run: |
        echo "Installing yamllint..."
        pip install yamllint
        
        echo "Validating YAML files for syntax and style..."
        
        # Run yamllint on data directory
        if [ -d "data" ]; then
          yamllint data/
          echo "✅ All YAML files in data/ directory are valid!"
        else
          echo "⚠️  data/ directory not found, skipping YAML validation"
        fi
        
        # Also validate workflow files
        if [ -d ".github/workflows" ]; then
          yamllint .github/workflows/
          echo "✅ GitHub workflow YAML files are valid!"
        fi
        
    - name: Check Python code formatting with Black
      run: |
        echo "Checking Python code formatting..."
        black --check --diff .
        
    - name: Lint Python code with flake8
      run: |
        pip install flake8
        echo "Linting Python code..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=node_modules,dist
        
    - name: Test site generation
      run: |
        echo "Testing site generation..."
        python generate_site.py
        
    - name: Build CSS with Tailwind
      run: |
        echo "Building CSS..."
        npm run build-css || npm run build || echo "No build script found, skipping CSS build"
        
    - name: Validate generated HTML
      run: |
        echo "Validating generated HTML..."
        if [ -f "index.html" ]; then
          echo "✅ index.html generated successfully"
          # Basic HTML validation - check if file contains expected structure
          if grep -q "<html" index.html && grep -q "</html>" index.html; then
            echo "✅ HTML structure looks valid"
          else
            echo "❌ HTML structure appears invalid"
            exit 1
          fi
        else
          echo "❌ index.html was not generated"
          exit 1
        fi
        
    - name: Deploy to GitHub Pages (on push to main/master)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: '.github,node_modules,data,*.mako,*.py,requirements.txt,pyproject.toml,tailwind.config.js,src'
